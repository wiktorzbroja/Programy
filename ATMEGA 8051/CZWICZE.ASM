STOPER SET 20H ; FLAGA STOPERA
T2MOD SET 0C9H ;USTAWIENIA L2
T2CON SET 0C8H
RCAP2H SET 0CBH
RCAP2L SET 0CAH
TH2 SET 0CDH
TL2 SET 0CCH

DPH0 SET 40H ; START STOPERA
DPL0 SET 41H
TH20 SET 42H
TL20 SET 43H

DPH1 SET 50H ; STOP STOPERA
DPL1 SET 51H
TH21 SET 52H
TL21 SET 53H
	
DPHd SET 60H ; OBLICZONY CZAS
DPLd SET 61H
TH2d SET 62H
TL2d SET 63H

LJMP INIT

ORG 003H
LJMP IRQINT0

ORG 02BH
LJMP IRQT2

ORG 50H
INIT:
;USTAWIANIE ZLICZANIA TR2
MOV T2CON,#00000100B
;USTAWIANIE LICZENIA 1000 IMPULSÓW
;MA LICZYC OD 55535 CZYLI D8EF
MOV TH2, #0D8H
MOV TL2, #0EFH
MOV RCAP2H,TH2 ; wartosc startowa licznika T2
MOV RCAP2L,TL2
;USTAWIANIE WEJSCIA INT0
MOV TMOD, #00001100B; ODLICZA TYLKO WTEDY GDY NA INT0 JEST 1
		    ; TIMER ODLICZA ZDARZENIA NA WEJSCIU T0
MOV TCON,#00000001B; MA DZIALAC NA ZBOCZE OPADAJACE
; USTAWIENIE PRZERWAN

SETB EA; WLACZA SYSTEM PRZERWAN
SETB EX0; Z INT0
SETB IE.5; Z T2
LJMP START

ORG 100H
START:
INC R7
LJMP START

ORG 200H
; Procedura obsLugujAca przerwanie od licznika T2. W procedurze tej zliczamy
;przepeLnienia w 16 bitowym rejestrze DPTR 
IRQT2:
INC DPTR
RETI


IRQINT0:
JB STOPER, STOP; SKOK JESLI FLAGA USTAWIONA
;JEZELI NIE JEST USTAWIONA, ZAPISZ WARTOSCI START STOPERA
MOV DPH0,DPH
MOV DPL0,DPL
MOV TH20,TH2
MOV TL20,TL2
SETB STOPER; STOPER JEST WLACZONY
LJMP ENDINT0

STOP:
MOV DPH1,DPH ;ZAPIS STOP
MOV DPL1,DPL
MOV TH21,TH2
MOV TL21,TL2

	CLR C
	MOV A,DPL1
	SUBB A,DPL0 ; DPLd = DPL1 - DPL0
	MOV DPLd,A
	MOV A,DPH1
	SUBB A,DPH0 ; DPHd = DPH1 - DPH0 - C
	MOV DPHd,A
	
	CLR C
	MOV A,TL21
	SUBB A,TL20 ; TL2d = TL21 - DTL20
	MOV TL2d,A
	MOV A,TH21
	SUBB A,TH20 ; TH2d = TH21 - TH20 - C
	MOV TH2d,A
	
MOV TH2,RCAP2H ; ustawienie licznika na pozycji startowej (zerowanie)
MOV TL2,RCAP2L
CLR STOPER ; wylaczenie flagi stopera	

ENDINT0:
RETI
END